name: Build & Deploy (GHCR + Tailscale OAuth + SSH)

on:
  push:
    branches: ["main"]
    tags:
      - "v*.*.*"
  workflow_dispatch: {}

concurrency:
  group: deploy-main
  cancel-in-progress: true

env:
  IMAGE_NAME: ghcr.io/sharru0701/workout-log-web

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata (tags + labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=long,prefix=
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build & Push (web)
        uses: docker/build-push-action@v6
        with:
          context: ./web
          file: ./web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Tailscale connect (OAuth, tag:ci)
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Install rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync

      - name: Setup SSH key
        shell: bash
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          printf '%s' "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Ensure /opt/workout-log exists
        shell: bash
        run: |
          ssh -T -o StrictHostKeyChecking=yes \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            "sudo mkdir -p /opt/workout-log/deploy && sudo chown -R ${{ secrets.DEPLOY_USER }}:${{ secrets.DEPLOY_USER }} /opt/workout-log"

      - name: Upload deploy bundle to server
        shell: bash
        run: |
          rsync -avz --delete \
            --exclude ".env" \
            -e "ssh -o StrictHostKeyChecking=yes" \
            ./deploy/ "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/opt/workout-log/deploy/"

      - name: Deploy image by commit SHA (capture rollback SHA)
        id: deploy_sha
        shell: bash
        run: |
          set -euo pipefail

          rollback_sha="$(ssh -T -o StrictHostKeyChecking=yes "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" <<'EOF'
          set -euo pipefail
          cd /opt/workout-log/deploy

          if [[ -s .last_successful_web_sha ]]; then
            cat .last_successful_web_sha
            exit 0
          fi

          current_image="$(docker inspect -f '{{.Config.Image}}' workoutlog-web 2>/dev/null || true)"
          current_tag="${current_image##*:}"

          if [[ "${current_tag}" =~ ^[0-9a-f]{40}$ ]]; then
            echo "${current_tag}"
          fi
          EOF
          )"

          rollback_sha="$(
            printf '%s\n' "${rollback_sha}" \
              | tr -d '\r' \
              | grep -E '^[0-9a-f]{40}$' \
              | tail -n1 \
              | xargs || true
          )"
          echo "rollback_sha=${rollback_sha}" >> "$GITHUB_OUTPUT"
          echo "Rollback candidate SHA: ${rollback_sha:-<none>}"

          ssh -T -o StrictHostKeyChecking=yes \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" <<EOF
          set -euo pipefail
          cd /opt/workout-log/deploy
          export WEB_IMAGE_TAG=${{ github.sha }}
          docker compose pull web
          echo "[deploy] running dedicated migration job before switching web container"
          docker compose run --rm migrate
          docker compose up -d --no-deps web
          docker compose ps
          EOF

      - name: Healthcheck (from deploy server)
        id: healthcheck
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail

          HEALTHCHECK_URL="${{ secrets.DEPLOY_HEALTHCHECK_URL }}"
          if [[ -z "${HEALTHCHECK_URL}" ]]; then
            HEALTHCHECK_URL="http://127.0.0.1:3001/api/health?checkMigrations=1&requiredTables=program_template,user_setting,ux_event_log,migration_run_log"
          fi

          echo "Healthcheck URL: ${HEALTHCHECK_URL}"

          for i in $(seq 1 18); do
            if ssh -T -o StrictHostKeyChecking=yes \
              "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
              "curl -fsS --max-time 8 '${HEALTHCHECK_URL}' >/dev/null"; then
              echo "Healthcheck passed (${i}/18)"
              exit 0
            fi
            echo "Healthcheck retry (${i}/18)"
            sleep 5
          done

          echo "Healthcheck failed. Dumping server diagnostics..."
          ssh -T -o StrictHostKeyChecking=yes \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            "cd /opt/workout-log/deploy && docker compose ps && docker compose logs --tail=120 web postgres || true"
          exit 1

      - name: Migration telemetry alert check
        if: ${{ steps.healthcheck.outcome == 'success' }}
        id: migration_telemetry
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail

          OPS_TOKEN="${{ secrets.DEPLOY_OPS_TOKEN }}"
          if [[ -z "${OPS_TOKEN}" ]]; then
            echo "DEPLOY_OPS_TOKEN not set. Skipping migration telemetry alert check."
            exit 0
          fi

          LOOKBACK_MINUTES="${{ vars.DEPLOY_MIGRATION_ALERT_LOOKBACK_MINUTES }}"
          if [[ -z "${LOOKBACK_MINUTES}" ]]; then
            LOOKBACK_MINUTES=120
          fi

          TELEMETRY_URL="http://127.0.0.1:3001/api/ops/migrations?lookbackMinutes=${LOOKBACK_MINUTES}&limit=10"
          echo "Telemetry URL: ${TELEMETRY_URL}"

          response="$(ssh -T -o StrictHostKeyChecking=yes \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            "curl -sS --max-time 8 -H 'x-ops-token: ${OPS_TOKEN}' -w '\n%{http_code}' '${TELEMETRY_URL}'")"

          http_code="$(printf '%s\n' "${response}" | tail -n1)"
          payload="$(printf '%s\n' "${response}" | sed '$d')"

          echo "Migration telemetry response (status=${http_code}):"
          echo "${payload}"

          strict_mode="${{ vars.DEPLOY_MIGRATION_ALERT_STRICT }}"
          if [[ -z "${strict_mode}" ]]; then
            strict_mode=0
          fi

          if [[ "${http_code}" -ge 400 ]]; then
            echo "::warning::Migration telemetry endpoint returned HTTP ${http_code}"
            if [[ "${strict_mode}" == "1" ]]; then
              echo "DEPLOY_MIGRATION_ALERT_STRICT=1, failing deploy."
              exit 1
            fi
            exit 0
          fi

          status="$(printf '%s' "${payload}" | node -e "const fs=require('fs');const raw=fs.readFileSync(0,'utf8');const d=JSON.parse(raw||'{}');process.stdout.write(String(d.status||''));")"
          reasons="$(printf '%s' "${payload}" | node -e "const fs=require('fs');const raw=fs.readFileSync(0,'utf8');const d=JSON.parse(raw||'{}');const r=Array.isArray(d.reasons)?d.reasons:[];process.stdout.write(r.join(','));")"

          if [[ "${status}" == "critical" ]]; then
            echo "::warning::Migration telemetry is critical (${reasons:-unknown})"
            if [[ "${strict_mode}" == "1" ]]; then
              echo "DEPLOY_MIGRATION_ALERT_STRICT=1, failing deploy."
              exit 1
            fi
          fi

      - name: Mark successful deployed SHA
        if: ${{ steps.healthcheck.outcome == 'success' && steps.migration_telemetry.outcome != 'failure' }}
        id: mark_success
        shell: bash
        run: |
          ssh -T -o StrictHostKeyChecking=yes \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            "printf '%s' '${{ github.sha }}' > /opt/workout-log/deploy/.last_successful_web_sha"

      - name: Rollback to previous SHA
        if: ${{ always() && (steps.healthcheck.outcome == 'failure' || steps.migration_telemetry.outcome == 'failure' || steps.mark_success.outcome == 'failure') && steps.deploy_sha.outputs.rollback_sha != '' }}
        shell: bash
        run: |
          set -euo pipefail
          ROLLBACK_SHA="${{ steps.deploy_sha.outputs.rollback_sha }}"
          echo "Rolling back to ${ROLLBACK_SHA}"

          ssh -T -o StrictHostKeyChecking=yes \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" <<EOF
          set -euo pipefail
          cd /opt/workout-log/deploy
          export WEB_IMAGE_TAG=${ROLLBACK_SHA}
          docker compose pull web || true
          docker compose up -d --no-deps web
          docker compose ps
          EOF

      - name: Verify rollback health
        if: ${{ always() && (steps.healthcheck.outcome == 'failure' || steps.migration_telemetry.outcome == 'failure' || steps.mark_success.outcome == 'failure') && steps.deploy_sha.outputs.rollback_sha != '' }}
        shell: bash
        run: |
          set -euo pipefail

          HEALTHCHECK_URL="${{ secrets.DEPLOY_HEALTHCHECK_URL }}"
          if [[ -z "${HEALTHCHECK_URL}" ]]; then
            HEALTHCHECK_URL="http://127.0.0.1:3001/api/health?checkMigrations=1&requiredTables=program_template,user_setting,ux_event_log,migration_run_log"
          fi

          echo "Rollback healthcheck URL: ${HEALTHCHECK_URL}"

          for i in $(seq 1 12); do
            if ssh -T -o StrictHostKeyChecking=yes \
              "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
              "curl -fsS --max-time 8 '${HEALTHCHECK_URL}' >/dev/null"; then
              echo "Rollback healthcheck passed (${i}/12)"
              exit 0
            fi
            echo "Rollback healthcheck retry (${i}/12)"
            sleep 5
          done

          echo "Rollback healthcheck failed. Dumping server diagnostics..."
          ssh -T -o StrictHostKeyChecking=yes \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            "cd /opt/workout-log/deploy && docker compose ps && docker compose logs --tail=120 web postgres || true"
          exit 1

      - name: Fail workflow when deploy healthcheck failed
        if: ${{ always() && (steps.healthcheck.outcome == 'failure' || steps.migration_telemetry.outcome == 'failure' || steps.mark_success.outcome == 'failure') }}
        shell: bash
        run: |
          echo "Deploy verification failed (healthcheck or strict migration telemetry). Rollback attempted automatically."
          exit 1
